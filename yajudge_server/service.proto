syntax = "proto3";

// protoc --go-grpc_out=. --go_out=. service.proto

option go_package = "./;core_service";

package service;

enum Role {
  ROLE_ANY                = 0;
  ROLE_UNAUTHORIZED       = 1;
  ROLE_STUDENT            = 2;
  ROLE_TEACHER_ASSISTANT  = 3;
  ROLE_TEACHER            = 4;
  ROLE_LECTUER            = 5;
  ROLE_ADMINISTRATOR      = 6;
}

message User {
  int64       id          = 1;
  string      first_name  = 2;
  string      last_name   = 3;
  string      mid_name    = 4;
  string      email       = 5;
  string      password    = 6;
  string      group_name  = 7;
  Role        default_role= 8;
  bool        disabled    = 9;
}

message Session {
  string      cookie      = 1;
  int64       user_id     = 2;
  int64       start       = 3;
}

message Nothing {
  bool        dummy       = 1;
}

message UsersFilter {
  Role        role                = 1;
  User        user                = 2;
  Course      course              = 3;
  bool        partial_string_match = 4;
  bool        include_disabled    = 5;
}

message UsersList {
  repeated User users     = 1;
}

message TextReading {
  int64       id          = 1;
  int64       lessons_id  = 2;
  string      title       = 3;
  string      content_type= 4;  // text/mardown by default
  string      data        = 5;
  string      external_url= 6;
}

message File {
  string      name        = 1;
  string      content_type= 2;
  bytes       data        = 3;
}

message FileSet {
  repeated File   files = 1;
}

enum Arch {
  ARCH_ANY    = 0;
  ARCH_X86    = 1;
  ARCH_X86_64 = 2;
  ARCH_ARMV7  = 3;
  ARCH_AARCH64= 4;
}

enum OS {
  OS_ANY      = 0;
  OS_POSIX    = 1;
  OS_LINUX    = 2;
  OS_BSD      = 3;
  OS_WINDOWS  = 4;
}


message GradingPlatform {
  Arch            arch        = 1; // ARCH_ANY for generic problems
  OS              os          = 2; // OS_ANY for too generic problems, OS_POSIX for most common
  repeated string compilers   = 3; // gcc, g++, gas, javac, and so on
  repeated string tools       = 4; // additional tools required like cmake
  repeated string libraries   = 5; // additional libraries required (in terms of pkg-config for C/C++)
}

message GradingLimits {
  int64           memory_limit_mb     = 1;
  int64           cpu_time_limit_sec  = 2;
  int64           real_time_limit_sec = 3;
  // todo more options
}

message TestCase {
  bool            blocks_submission           = 1; // important in case if patial tests allowed, ignored otherwise
  string          description                 = 2; // optional
  string          command_line_arguments      = 3; // optional
  File            stdin_data                  = 4;
  File            stdout_reference            = 5;
  File            stderr_reference            = 6;
  int64           retval_reference            = 7;
  FileSet         input_extra_files           = 8;
  FileSet         output_reference_extra_files= 9;
}

message GradingOptions {
  GradingPlatform   platform_required     = 1; // to match corresponding grader client
  GradingLimits     limits                = 2;
  repeated TestCase test_cases            = 3;
  string            standard_checker      = 4; // named by ejudge checkers name
  string            standard_checker_opts = 5; // like ejudge checker environment
  FileSet           custom_checker        = 6; // checker source files
  FileSet           custom_interactor     = 7; // interactor soure files
}

message ProblemData {
  // These data structures are not stored in database, but attached to courses via Problem records

  string          id                            = 1;  // string, but not int! id is a relative path to the problem directory
  string          statement_text                = 2;
  string          statement_content_type        = 3;  // text/mardown by default
  FileSet         statement_files               = 4;
  FileSet         solution_files                = 5;  // fileset meta-information to be filled by solution
  float           full_score_multiplier_propose = 6;  // 1.0 by default, >1 for hard problems, <1 for easy problems
  GradingOptions  grading_options               = 7;

  // This is problem property but not a problem usage in course/lesson property!
  // Cons: the problem solution might be demonstrated sometime in past at another course
  bool            skip_plagiarism_check         = 8;
}

message Problem {
  int64           id                      = 1;
  int64           lessons_id              = 2;
  string          name                    = 3;
  int64           show_atfer_id           = 4;
  ProblemData     problem_data            = 5;  // to be found at some know place in filesystem
  int64           open_date               = 6;  // 0 for inherit from outer lesson
  int64           soft_deadline           = 7;  // 0 for inherit from outer lesson
  int64           hard_deadline           = 8;  // 0 for inherit from outer lesson
  float           full_score_multiplier   = 9;  // 1.0 by default, >1 for hard problems, <1 for easy problems
  bool            blocks_positive_mark    = 10;
  bool            blocks_next_problem     = 11;
  bool            accept_partial_tests    = 12;
  bool            skip_solution_defence   = 13;
  bool            skip_code_review        = 14;
}

enum SolutionStatus {
  SUBMITTED           = 0;
  GRADE_IN_PROGRESS   = 1;
  COMPILATION_ERROR   = 2;
  VERY_BAD            = 3;  // no one test passed
  ACCEPTABLE          = 4;  // grade score > 0 (if accept partial solution) or score is full
  CODE_REVIEW_REJECTED= 5;
  DEFENCE_FAILED      = 6;
  PLAGIARISM_DETECTED = 7;
  DISQUALIFIED        = 8;
  OK                  = 100;
}

message ReviewComment {
  int64               id              = 1;
  int64               code_reviews_id = 2;
  string              related_file    = 3;  // might be empty in case if solution has just one file
  int64               start_position  = 4;  // position in text (chars count, not lines or bytes)
  int64               end_position    = 5;  // position in text (chars count, not lines or bytes)
}

message CodeReview {
  int64                   id            = 1;
  int64                   submission_id = 2;
  User                    author        = 3;
  repeated ReviewComment  code_comments = 4;
  string                  global_comment= 5;
}

message Submission {
  int64               id            = 1;
  FileSet             solution_files= 2;
  SolutionStatus      status        = 3;
  float               grader_score  = 4;
  string              grader_name   = 5;  // id of grader that processed submission
  string              grader_output = 6;  // stdout output by testing system
  string              grader_errors = 7;  // stderr output by testing system
  CodeReview          code_review   = 8;
  ProblemData             problem       = 9;  // just references Problem.id in most cases, but contains full data for grader
}

message Solution {
  int64                id      = 1;
  ProblemData              problem = 2;  // must contain at least Problem.id
  repeated Submission  history = 3;
}

message Lesson {
  int64                 id            = 1;
  int64                 sections_id   = 2;  // required for creating new lesson in some section
  string                name          = 3;
  repeated  TextReading readings      = 4;
  repeated  ProblemData     problems      = 5;
  int64                 open_date     = 6;  // 0 for inherit from outer section
  int64                 soft_deadline = 7;  // 0 for inherit from outer section
  int64                 hard_deadline = 8;  // 0 for inherit from outer section
  int64                 show_after_id = 9;  // determine display order: 0 for first lesson, 999 for undefined
}

message Section {
  int64                 id            = 1;
  int64                 courses_id    = 2;  // required for creating new section in some course
  string                name          = 3;
  repeated Lesson       lessons       = 4;
  int64                 open_date     = 5;
  int64                 soft_deadline = 6;
  int64                 hard_deadline = 7;
  int64                 show_after_id = 8;  // determine display order: 0 for first lesson, 999 for undefined
}

message Course {
  int64             id          = 1;
  string            name        = 2;
  repeated Section  sections    = 3;
}

message Enrolment {
  Course      course      = 1;
  User        user        = 2;
  Role        role        = 3;
}

message UserRole {
  User        user        = 1;
  Role        role        = 2;
}


service UserManagement {
  rpc Authorize(User) returns (Session) {}
  rpc GetProfile(Session) returns (User) {}
  rpc GetUsers(UsersFilter) returns (UsersList) {}
  rpc SetUserDefaultRole(UserRole) returns (UserRole) {}
  rpc CreateOrUpdateUser(User) returns (User) {}
  rpc ResetUserPassword(User) returns (User) {}
  rpc ChangePassword(User) returns (User) {}
}

message Enroll {
  Course        course  = 1;
  User          user    = 2;
  Role          role    = 3;
}

message CoursesFilter {
  User          user                  = 1;  // courses available to specified user, no filter in case of User.id==0
  Course        course                = 2;  // filter by name, no filter in case of Course.id==0
  bool          partial_string_match  = 3;
}

message CoursesList {
  message CourseListEntry {
    Course  course  = 1;
    Role    role    = 2;
  }
  repeated CourseListEntry  courses = 1;
}

service CourseManagement {
  rpc CreateOrUpdateCourse(Course) returns (Course) {}
  rpc EnrollUser(Enroll) returns (Course) {}
  rpc CloneCourse(Course) returns (Course) {}
  rpc DeleteCourse(Course) returns (Nothing) {}
  rpc CreateOrUpdateSection(Section) returns (Section) {}
  rpc DeleteSection(Section) returns (Nothing) {}
  rpc DeleteLesson(Lesson) returns (Nothing) {}
  rpc CreateOrUpdateLesson(Lesson) returns (Lesson) {}
  rpc CreateOrUpdateTextReading(TextReading) returns (TextReading) {}
  rpc CreateOrUpdateProblem(Problem) returns (Problem) {}
  rpc GetCourses(CoursesFilter) returns (CoursesList) {}
}

message GraderProperties {
  string          name        = 1;
  GradingPlatform platform    = 2;
}

service SubmissionsManagement {
  // anounce grader alive and receive stream of submissions to be graded
  rpc ReceiveSubmissionsToGrade(GraderProperties) returns (stream Submission) {}

  // argument filled by id, status, grader_score, grader_name, grader_output, grader_errors
  rpc UpdateGraderOutput(Submission) returns (Submission) {}
}
